# 概述
aispace 25.0.0.1 融合部署（fke+aispace 融合部署方案）

# 安装宿主机操作系统
FusionOS 23.2.1，如 **FusionOS-23_23.2.1_everything_x86_64.iso**；

系统盘要求的介质类型/存储空间，**SSD / 480G及以上**；

语言要求为**英文**；

## 控制平面/计算 节点系统盘分区
系统分区严格按照 fke+aispace 融合部署方案，要求LVM类型分区，分控制平面/计算节点的系统盘分区，对于单节点需要均满足控制平面/计算节点的系统盘分区要求；

分区 /boot/efi 设置有要求，参考 **安装过程中的注意事项**；

控制平面节点的系统盘分区
| 分区                 | 大小    |
| -------------------- | ------- |
| /                    | 20GiB   |
| /root/bak            | 20GiB   |
| /var/lib/etcd        | 20GiB   |
| /var/log             | 36GiB   |
| /var/fusiononecenter | 80GiB   |
| /home                | 60GiB   |
| /boot                | 1024MiB |
| /boot/efi            | 600MiB  |

工作节点的系统盘分区
| 分区                 | 大小    |
| -------------------- | ------- |
| /                    | 20GiB   |
| /root/bak            | 20GiB   |
| /var/log             | 36GiB   |
| /home                | 60GiB   |
| /boot                | 1024MiB |
| /boot/efi            | 600MiB  |

安装过程中的注意事项，
- 若没有设置 UEFI，则 /boot/efi 分区无需存在；
- 不要设置 swap 分区；
- 需要修改 home 分区 `Modify` 弹框中的 `Size policy` 为 `As large as possible`，设置 `Name` 为 `fusionos`； **<------ 这个很重要，不做的话有可能会导致后面"部署容器"的 fke+aispace 一体化安装失败**

## 配置网络
单个网口配置的，这部分通过 BMC KVM 方式安装OS时可通过图形化界面进行配置，
```shell
ip addr
vim /etc/sysconfig/network-scripts/ifcfg-xxxxxx
  BOOTPROTO=static
  ONBOOT=yes
  IPADDR=x.x.x.x
  PREFIX=x.x.x.x / x
  GATEWAY=x.x.x.x
  DNS1=x.x.x.x

systemctl restart NetworkManager
ip addr
```
如果是组bond口的，参考产品文档；

# 宿主机操作系统设置
OS 安装完毕之后，进行一些基础设置， 

## 关闭 selinux
```shell
setenforce 0
vi /etc/selinux/config
```
修改参数项 `SELINUX` 为 `disabled` ，修改需要重启生效；

## 关闭防火墙
```shell
systemctl disable firewalld --now
systemctl status firewalld
```

## 配置最大文件打开数
配置 max_user_instances
```shell
echo fs.inotify.max_user_instances=8192| tee -a /etc/sysctl.conf && sudo sysctl -p
```

配置系统级资源限制
```shell
echo "root soft nofile 204800
root hard nofile 204800
root soft nproc 204800
root hard nproc 204800" >> /etc/security/limits.conf
```

配置用户级资源限制
```shell
echo DefaultLimitNOFILE=204800 >>  /etc/systemd/system.conf
echo DefaultLimitNOFILE=204800 >>  /etc/systemd/user.conf
```
执行 `reboot -f` 命令重启系统才能使配置生效

执行以下命令检测配置是否成功
```shell
ulimit -n 
  204800
```

查看用户级是否修改成功
```shell
su - root -c 'ulimit -aHS' -s '/bin/bash'
```
回显示例如下，
```shell
su - root -c 'ulimit -aHS' -s '/bin/bash'
  real-time non-blocking time  (microseconds, -R) unlimited
  core file size              (blocks, -c) 0
  data seg size               (kbytes, -d) unlimited
  scheduling priority                 (-e) 0
  file size                   (blocks, -f) unlimited
  pending signals                     (-i) 63499
  max locked memory           (kbytes, -l) 2046468
  max memory size             (kbytes, -m) unlimited
  open files                          (-n) 204800
  pipe size                (512 bytes, -p) 8
  POSIX message queues         (bytes, -q) 819200
  real-time priority                  (-r) 0
  stack size                  (kbytes, -s) 8192
  cpu time                   (seconds, -t) unlimited
  max user processes                  (-u) 204800
  virtual memory              (kbytes, -v) unlimited
  file locks                          (-x) unlimited
```

## 配置时间
检查时区时间，设置时区
```shell
timedatectl
timedatectl set-timezone Asia/Shanghai
```
手动设置系统时间
```shell
date -s "xxxx-xx-xx xx:xx:xx"
```
将系统时间同步到硬件时钟
```shell
hwclock --systohc
```

# 安装 NV 显卡驱动
禁用nouveau驱动，执行以下命令将 nouveau 驱动加入黑名单，
```shell
echo "blacklist vga16fb
blacklist nouveau
blacklist rivafb
blacklist rivatv
blacklist nvidiafb" >> /etc/modprobe.d/blacklist.conf
```

执行 `dracut --force` 命令更新现有 initramfs 映像文件，
```shell
dracut --force
```


# 部署容器
mkdir /home/fke/installer
mkdir /home/fke/management
cp /the/path/of/FusionOneKubernetesEngine_BM_23.3.1_x86_64.zip /home/fke/management/
cp /the/path/of/FusionOneKubernetesEngine_BM_23.3.1_x86_64_Configure.zip /home/fke/installer/
cd /home/fke/installer/
unzip FusionOneKubernetesEngine_BM_23.3.1_x86_64_Configure.zip -d ./
sh /home/fke/installer/appctl.sh install
systemctl status configure-wizard
  Activce: active (running)













